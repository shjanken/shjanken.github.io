+++
title = "二手车数据分析"
author = ["janken.wang@hotmail.com"]
draft = false
+++

## 引用 {#引用}

> 康康，这里面是两层意思，一个意思是统计二一年买进以后，然后这个三个月内卖掉的这个数量，那么其中分单位和个人，还有一个数字是在这个里面要去掉这个洗牌的因素，也就是说一般来讲，这个一年交易三次的，就是洗牌的这个意思。在这个数量里面，那么交易了三两的个人和单位是多少

<!--quoteend-->

> 2021年，购买且持有3个月内的数量，分个人和单位
> 其中一年内交易3次及以上的数量分个人和单位。
> 车辆类型为小微型载客，使用性质为非营运、营转非，出租转非，预约岀租转非。


## 分析 2021 年过户车辆中的多次交易车辆 (洗澡车) {#分析-2021-年过户车辆中的多次交易车辆--洗澡车}

使用 `python` 和 `pandas` 分析 2021 年的交易数据
查询3个月内交易的车辆数据, 并且排除一年内多次交易的车辆(洗澡车)


### 准备原始数据 {#准备原始数据}

从数据库中查找所有 2021 年 1 月到 2022 年 3 月份的交易记录

```python
sql = """
select xh, slrq, yw, syq, hphm from ylrjy
where slrq between to_date('20210101','YYYYMMDD') and to_date('20220401', 'YYYYMMDD')
and ysyxz in('A','L','M','U')
and substr(cllx,1,2) in('K3','K4')
order by slrq
"""

cursor = connection.cursor()
cursor.execute(sql)

results = cursor.fetchall()
```


### 从 2021 年 1 月到 2022 年 3 月的所有交易过的车辆数据 {#从-2021-年-1-月到-2022-年-3-月的所有交易过的车辆数据}

将数据库中读取到的数据创建为 `pandas DataFrame`, 方便后续的分析

```python
import pandas as pd

original_df = pd.DataFrame(results,columns=['xh', 'slrq', 'yw', 'syq', 'hphm'])
original_df
```

```text
                    xh                slrq  yw syq    hphm
0       31000012462935 2021-01-04 08:20:54  C1   2    None
1       31000006090006 2021-01-04 08:26:29  B5   2  FMS296
2       31011918169311 2021-01-04 08:26:38  C1   2    None
3       31000012074570 2021-01-04 08:27:41  B3   2  C3C1B8
4       31111116241507 2021-01-04 08:27:55  B4   2  C0F6Z6
...                ...                 ...  ..  ..     ...
505741  31000007560531 2022-03-31 10:36:35  B5   2  EQY753
505742  31000007140735 2022-03-31 10:38:11  B5   2  FUC803
505743  31000016463301 2022-03-31 11:07:39  C1   2    None
505744  31000012155246 2022-03-31 12:23:35  B5   2  DVU181
505745  31090312358733 2022-03-31 12:26:16  C1   2    None

[505746 rows x 5 columns]
```

一共有 **505747** 条数据


### 2021 年购买且持有3个月以内的车辆 {#2021-年购买且持有3个月以内的车辆}

过滤交易列表. 获取3个月交易过的车辆数据

1.  根据 xh 分组
2.  如果小组里面的数据只有一条, 则直接将数据去除, 因为这个车子没有再次交易过
3.  每个小组里面的记录按照 slrq 升序排序
4.  排序之后的数据, 如果第一条记录不是 B3, B4 或者 B5, 并且不是在 2022 年 01 01 日之前的, 直接将这组数据去除
5.  计算小组中每条数据和前一条数据之间的间隔, 如果没有任何一条数据和之前的数据间隔在3个月之内的, 去除这组数据

<!--listend-->

```python
def is_trade_in_three_month(trade_record):
    if len(trade_record) <= 1:
        return False

    trade_record.sort_values(by=['slrq'])

    if not trade_record['yw'].head(1).isin(['B3', 'B4', 'B5']).bool():
        return False

    return trade_record['slrq'].diff().apply(lambda td: td < np.timedelta64(3, "M")).any()
trade_in_three_month_df = original_df.groupby('xh').filter(is_trade_in_three_month)
trade_in_three_month_df.sort_values(by=['xh', 'slrq'])
```

```text
                    xh                slrq  yw syq    hphm
43559   11000005074685 2021-02-20 14:51:34  B4   2  C1898V
57293   11000005074685 2021-03-04 08:43:57  C1   2    None
247065  11000006012033 2021-08-03 08:31:55  B4   1  C91X51
310483  11000006012033 2021-09-24 11:07:26  C1   2    None
23241   11000006046781 2021-01-22 09:55:38  B4   1  C2J3G6
...                ...                 ...  ..  ..     ...
18603   65010013016486 2021-01-18 15:20:08  B4   1  C2017E
59876   65010013016486 2021-03-05 11:07:16  B5   2  A31N52
448024  65010013016486 2022-01-18 14:03:44  C1   2    None
410457  65010018098829 2021-12-20 10:07:31  B4   1  C150RZ
457059  65010018098829 2022-01-26 10:37:54  B3   2  C8V9L5

[207952 rows x 5 columns]
```

将这些数据按照 xh 去重.

```python
trade_in_three_month_df.drop_duplicates('xh').sort_values('xh')
```

```text
                    xh                slrq  yw syq    hphm
43559   11000005074685 2021-02-20 14:51:34  B4   2  C1898V
247065  11000006012033 2021-08-03 08:31:55  B4   1  C91X51
23241   11000006046781 2021-01-22 09:55:38  B4   1  C2J3G6
343267  11000006048372 2021-10-25 12:14:35  B4   1  C0628J
39014   11000007042522 2021-02-05 14:14:41  B4   1  C9592R
...                ...                 ...  ..  ..     ...
210997  64010014276368 2021-07-02 10:45:26  B4   1  C10M66
53934   64010015274180 2021-03-02 09:44:45  B4   2  CQ6181
481443  64010020042118 2022-02-28 12:39:55  B4   1  C157G7
18603   65010013016486 2021-01-18 15:20:08  B4   1  C2017E
410457  65010018098829 2021-12-20 10:07:31  B4   1  C150RZ

[93339 rows x 5 columns]
```

这些不重复的数据就是3个月内交易的车辆. 按照 syq 分组

```python
trade_in_three_month_df.drop_duplicates('xh').groupby('syq')['syq'].count()
```

```text
syq
1    62358
2    30981
Name: syq, dtype: int64
```


### 2021 年 3 个月内交易的车辆中的多次交易车辆 {#2021-年-3-个月内交易的车辆中的多次交易车辆}

为了统计方便, 将记录总数作为一列添加到 `trade_in_three_month_df` 数据表上

```python
trade_cnt_ser = trade_in_three_month_df.groupby('xh')['xh'].transform('count')
trade_in_three_month_with_cnt_df = trade_in_three_month_df.copy()
trade_in_three_month_with_cnt_df['trade_cnt'] = trade_cnt_ser
trade_in_three_month_with_cnt_df
```

```text
                    xh                slrq  yw syq    hphm  trade_cnt
1       31000006090006 2021-01-04 08:26:29  B5   2  FMS296          2
12      31000012159706 2021-01-04 08:33:36  B4   1  C6A6Z9          2
13      31000015389254 2021-01-04 08:34:40  B4   1  C98898          2
21      31000009464622 2021-01-04 08:38:51  B4   1  CF6735          2
37      31090311109571 2021-01-04 08:46:27  B4   1  C2W1D7          2
...                ...                 ...  ..  ..     ...        ...
505737  31000009583074 2022-03-31 09:51:28  C1   2    None          2
505738  31000007118737 2022-03-31 09:53:33  C1   2    None          2
505739  31000013537154 2022-03-31 09:55:39  C1   2    None          2
505741  31000007560531 2022-03-31 10:36:35  B5   2  EQY753         34
505742  31000007140735 2022-03-31 10:38:11  B5   2  FUC803         61

[207952 rows x 6 columns]
```

从上面3个月内交易的报表中. 统计每个 xh 交易的数量, 去掉 `trade_cnt` 小于3的数据

1.  数据表按照 xh 分组
2.  分组以后的数据去掉 `trade_cnt` 小于3的数据\\

<!--listend-->

```python
trade_more_than_three_times_df = trade_in_three_month_with_cnt_df.query('trade_cnt > 3')
trade_more_than_three_times_df.sort_values(['xh', 'slrq']).head(50)
```

```text
                    xh                slrq  yw syq    hphm  trade_cnt
39014   11000007042522 2021-02-05 14:14:41  B4   1  C9592R          4
192329  11000007042522 2021-06-18 13:00:11  B5   2  DJB602          4
253436  11000007042522 2021-08-09 08:42:56  B5   2  FZR123          4
443707  11000007042522 2022-01-14 12:20:06  B4   2  C970P5          4
93118   11000009028070 2021-03-30 10:47:43  B4   2  CAC000          4
225114  11000009028070 2021-07-14 11:06:33  B5   2  FDR167          4
282856  11000009028070 2021-08-31 14:34:40  B4   1  CDD727          4
292621  11000009028070 2021-09-08 09:59:37  C1   2    None          4
106488  11000009041559 2021-04-09 15:19:24  B5   2  DBF053          5
194417  11000009041559 2021-06-21 12:57:18  B4   2  CYM919          5
216792  11000009041559 2021-07-07 10:49:37  B5   2  BFK802          5
232181  11000009041559 2021-07-20 13:04:00  B4   2  C7B316          5
258517  11000009041559 2021-08-11 14:17:26  B5   2  EUK030          5
47129   11000010104070 2021-02-24 10:13:22  B4   1  C8L5A9          4
59533   11000010104070 2021-03-05 09:59:47  B3   2  C2X8Z7          4
103431  11000010104070 2021-04-08 09:34:50  B5   1  BLT500          4
271064  11000010104070 2021-08-23 12:43:27  B5   2  ASQ296          4
79585   11010014408109 2021-03-19 10:09:11  B4   1  CF022H          4
143012  11010014408109 2021-05-11 10:17:00  B5   2  DMD221          4
264204  11010014408109 2021-08-17 10:23:08  B4   1  C2P5Y1          4
287910  11010014408109 2021-09-03 16:02:23  B5   2  B57A96          4
1200    11010014588569 2021-01-04 13:11:47  B3   2  C1Y8Q9          4
14109   11010014588569 2021-01-14 10:51:36  B5   1  DXL039          4
275033  11010014588569 2021-08-25 12:59:44  B4   2  C223ZK          4
468134  11010014588569 2022-02-16 12:46:14  B3   1  C5R9W9          4
59885   11010016160242 2021-03-05 11:09:26  B4   2  CL0353          6
64027   11010016160242 2021-03-09 09:33:17  B5   2  FEQ297          6
158506  11010016160242 2021-05-24 10:16:03  B4   2  C575H1          6
172028  11010016160242 2021-06-02 11:12:58  B3   2  CHL969          6
242655  11010016160242 2021-07-29 13:04:47  B3   1  C1R0K6          6
291845  11010016160242 2021-09-07 14:03:15  B5   2  B7L555          6
129444  11010016713317 2021-04-27 11:14:57  B4   2  C010V0          5
136589  11010016713317 2021-05-06 14:23:19  B3   2  C1E977          5
178236  11010016713317 2021-06-07 14:12:17  B5   2  EUP096          5
226758  11010016713317 2021-07-15 11:43:53  B4   2  C8M168          5
271157  11010016713317 2021-08-23 12:55:36  B3   2  C311AX          5
253307  11010207024314 2021-08-06 15:30:36  B4   1  C9F0D6          4
257021  11010207024314 2021-08-10 14:30:00  B5   2  FHS062          4
260265  11010207024314 2021-08-13 09:19:05  B4   1  C075ER          4
271936  11010207024314 2021-08-23 15:07:02  C1   2    None          4
174460  12000018252163 2021-06-03 14:45:52  B5   1  DLV176          4
294889  12000018252163 2021-09-09 13:16:40  B4   1  CEU079          4
372842  12000018252163 2021-11-17 14:05:35  B5   2  DRH009          4
409134  12000018252163 2021-12-17 09:17:39  B4   2  C217GP          4
86768   13020011107039 2021-03-24 15:52:24  B5   2  FQL966          4
276370  13020011107039 2021-08-26 11:00:00  B5   2  FHE101          4
341564  13020011107039 2021-10-22 12:44:53  B4   1  C659X1          4
436506  13020011107039 2022-01-10 10:51:46  B3   2  C976DZ          4
106173  13060117599649 2021-04-09 13:50:47  B4   1  CKW292          4
141012  13060117599649 2021-05-10 10:34:02  B5   2  ED5419          4
```

将 `trade_more_than_tree_times_df` 去重以后, 就得到了一年内交易超过3次的车辆数量

```python
trade_more_than_three_times_df.drop_duplicates('xh')
```

```text
                    xh                slrq  yw syq    hphm  trade_cnt
61      31000014377490 2021-01-04 08:53:57  B4   1    None          4
170     31000014101181 2021-01-04 09:23:19  B3   2  C7U7U5          4
311     31099411060792 2021-01-04 09:52:37  B5   2  FNH521         96
329     31000002544347 2021-01-04 09:56:29  B5   1  EBX530          7
616     31000006106661 2021-01-04 10:48:47  B5   2  DTW260         41
...                ...                 ...  ..  ..     ...        ...
480115  31000006029250 2022-02-25 15:45:30  B5   2  DQL190         12
481389  31000009821209 2022-02-28 12:31:12  B5   2  FXE617         10
484869  31000007568261 2022-03-02 09:43:45  B3   2  EHX595          5
486587  31000013145796 2022-03-03 09:48:59  B5   2  EJE228         10
487427  31000007054104 2022-03-03 13:22:57  B5   2  EGQ176          7

[1762 rows x 6 columns]
```

根据 `syq` 来统计数量

```python
trade_more_than_three_times_df.drop_duplicates('xh').groupby('syq')['syq'].count()
```

```text
syq
1    805
2    957
Name: syq, dtype: int64
```

根据 `syq` 统计洗澡车一共交易的数量

```python
trade_more_than_three_times_df.groupby('syq')['syq'].count()
```

```text
syq
1     4130
2    12246
Name: syq, dtype: int64
```


### 结论 {#结论}

|    | 3个月内再次交易的数量 (辆) | 洗澡车数量 ( 辆 ) | 洗澡车交易量 (次) |
|----|-----------------|-------------|------------|
| 单位 | 62358           | 805         | 4130       |
| 个人 | 30981           | 957         | 12246      |